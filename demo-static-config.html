<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>Conditions Demo</title>

  <script src="../webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="../polymer/polymer.html" />
  <link rel="import" href="at-rule-edit.html" />

  <style>
    #peraForm {
      position: relative;
      top: 0px;
      right: 0px;
      padding: 20px;
      width: 300px;
      background: #ddd;
    }

    #peraForm div {
      margin: 10px 0;
    }
  </style>

</head>

<body>
  <h2>Conditions and Actions Demo - static schema</h2>

  <at-rule-edit id="peraRules">
  </at-rule-edit>
  <form id="peraForm">
    <h3>Try Changing These Values...</h3>
    <div>
      <label>Damage</label>
      <input type="text" id="damageField" />
    </div>
    <div>
      <label>Health</label>
      <input type="text" id="healthField" />
    </div>
    <div>
      <label>Enemy</label>
      <select id="enemyField"></select>
    </div>
    <div>
      <button type="submit" id="perasubmit">Run Conditions and Actions</button>
    </div>
  </form>
  <div>
    <h3>Rule value echo:</h3>
    <div id="ruleValueEcho"></div>
  </div>
  <script>
    document.addEventListener('WebComponentsReady', function () {

      var ruleValueEcho = document.getElementById('ruleValueEcho');

      var enemyOptions = [
        {
          label: "",
          name: ""
        },
        {
          label: "Enemy1",
          name: "enemy1"
        },
        {
          label: "Enemy2",
          name: "enemy2"
        },
        {
          label: "Enemy3",
          name: "enemy3"
        },
      ];

      var ruleConfig = {
        conditions: [
          {
            label: "Damage",
            name: "damageField",
            operators: [
              {
                label: "is equal to",
                name: "equalTo",
                fieldType: "text"
              },
              {
                label: "is not equal to",
                name: "notEqualTo",
                fieldType: "text"
              },
            ]
          },
          {
            label: "Health",
            name: "healthField",
            operators: [
              {
                label: "is greater than or equal to",
                name: "greaterThanEqual",
                fieldType: "text"
              },
              {
                label: "is less than or equal to",
                name: "lessThanEqual",
                fieldType: "text"
              },
            ]
          },
          {
            label: "Enemy",
            name: "enemyField",
            options: enemyOptions,
            operators: [
              {
                label: "is present",
                name: "present",
                fieldType: "none"
              },
              {
                label: "is blank",
                name: "blank",
                fieldType: "none"
              },
              {
                label: "is equal to",
                name: "equalTo",
                fieldType: "select"
              },
              {
                label: "is not equal to",
                name: "notEqualTo",
                fieldType: "select"
              },
            ]
          }
        ],
        actions: [
          {
            label: "Show Alert",
            name: "alert",
            fields: [
              {
                label: "Message",
                name: "message",
                fieldType: "textarea"
              }
            ]
          },
          {
            label: "Update Field",
            name: "updateField",
            fields: [
              {
                label: "Field",
                name: "fieldId",
                fieldType: "select",
                options: [
                  {
                    label: "Damage to",
                    name: "damageField",
                    fields: [
                      {
                        label: "New Value",
                        name: "newValue",
                        fieldType: "text"
                      }
                  ]
                },
                  {
                    label: "Health to",
                    name: "healthField",
                    fields: [
                      {
                        label: "New Value",
                        name: "newValue",
                        fieldType: "text"
                      }
                  ]
                },
                  {
                    label: "Enemy to",
                    name: "enemyField",
                    fields: [
                      {
                        label: "New Value",
                        name: "newValue",
                        fieldType: "select",
                        options: enemyOptions
                      }
                  ]
                }
               ]
             },
            ]
          }
        ]
      };

      var ruleData = {
        conditions: {
          "all": [
            {
              name: "damageField",
              operator: "equalTo",
              value: "50"
            },
            {
              name: "healthField",
              operator: "lessThanEqual",
              value: "49"
            }
          ]
        },
        actions: [
          {
            name: "action-select",
            value: "alert",
            fields: [
              {
                name: "message",
                value: "You have been ... !"
              }
            ]
          },
          {
            name: "action-select",
            value: "updateField",
            fields: [
              {
                name: "fieldId",
                value: "enemyField",
                fields: [
                  {
                    name: "newValue",
                    value: "enemy3"
                  }
               ]
             }
            ]
          }
      ]
      };

      var peraRules = document.getElementById('peraRules');
      //      peraRules.conditions = peraConditionsConfig;
      //      peraRules.actions = peraActionsConfig;
      peraRules.ruleConfig = ruleConfig;
      peraRules.value = ruleData;

      peraRules.addEventListener('value-changed', function (event) {
        var jsonValue = JSON.stringify(peraRules.value);
        ruleValueEcho.textContent = jsonValue;
      });

      initializePeraForm(peraRules);
      window.peraRules = peraRules; // make it global, just for testing

      function initializePeraForm(pElement) {
        var enemyField = document.getElementById('enemyField');
        var healthField = document.getElementById('healthField');
        var damageField = document.getElementById('damageField');
        for (var i = 0; i < enemyOptions.length; i++) {
          var o = enemyOptions[i];
          var optionChild = document.createElement("option");
          optionChild.value = o.name;
          optionChild.text = o.label;
          enemyField.appendChild(optionChild);
        }

        var peraSubmit = document.getElementById('perasubmit');
        peraSubmit.addEventListener('click', function (e) {
          e.preventDefault();
          var lConditions = peraRules.collectConditionsData();
          var lActions = peraRules.collectActionsData();

          var engine = new RuleEngine({
            conditions: lConditions,
            actions: lActions
          });
          var conditionsAdapter = {
            damageField: damageField.value,
            healthField: healthField.value,
            enemyField: enemyField.value
          };
          var actionsAdapter = {
            alert: function (data) {
              alert(data.find("message"));
            },
            updateField: function (data) {
              console.log("data", data);
              var fieldId = data.find("fieldId");
              console.log("fieldId", fieldId);
              var field = document.getElementById(fieldId);
              var val = data.find("fieldId", "newValue");
              field.value = val;
            }
          };
          engine.run(conditionsAdapter, actionsAdapter);
        });
      }
    });
  </script>
</body>

</html>

<!-- This code is left here for reference -->
<!--
      // this is for the peraForm
      var peraConditionsConfig = {
        fields: [
          {
            label: "Damage",
            name: "damageField",
            operators: [
              {
                label: "is equal to",
                name: "equalTo",
                fieldType: "text"
              },
              {
                label: "is not equal to",
                name: "notEqualTo",
                fieldType: "text"
              },
            ]
          },
          {
            label: "Health",
            name: "healthField",
            operators: [
              {
                label: "is greater than or equal to",
                name: "greaterThanEqual",
                fieldType: "text"
              },
              {
                label: "is less than or equal to",
                name: "lessThanEqual",
                fieldType: "text"
              },
            ]
          },
          {
            label: "Enemy",
            name: "enemyField",
            options: enemyOptions,
            operators: [
              {
                label: "is present",
                name: "present",
                fieldType: "none"
              },
              {
                label: "is blank",
                name: "blank",
                fieldType: "none"
              },
              {
                label: "is equal to",
                name: "equalTo",
                fieldType: "select"
              },
              {
                label: "is not equal to",
                name: "notEqualTo",
                fieldType: "select"
              },
            ]
          }
        ],
        data: {
          "all": [
            {
              name: "damageField",
              operator: "equalTo",
              value: "50"
            },
            {
              name: "healthField",
              operator: "lessThanEqual",
              value: "49"
            }
          ]
        }
      }; // end of conditions config

      var peraActionsConfig = {
        fields: [
          {
            label: "Show Alert",
            name: "alert",
            fields: [
              {
                label: "Message",
                name: "message",
                fieldType: "textarea"
              }
            ]
          },
          {
            label: "Update Field",
            name: "updateField",
            fields: [
              {
                label: "Field",
                name: "fieldId",
                fieldType: "select",
                options: [
                  {
                    label: "Damage to",
                    name: "damageField",
                    fields: [
                      {
                        label: "New Value",
                        name: "newValue",
                        fieldType: "text"
                      }
                  ]
                },
                  {
                    label: "Health to",
                    name: "healthField",
                    fields: [
                      {
                        label: "New Value",
                        name: "newValue",
                        fieldType: "text"
                      }
                  ]
                },
                  {
                    label: "Enemy to",
                    name: "enemyField",
                    fields: [
                      {
                        label: "New Value",
                        name: "newValue",
                        fieldType: "select",
                        options: enemyOptions
                      }
                  ]
                }
               ]
             },
            ]
          }
        ],
        data: [
          {
            name: "action-select",
            value: "alert",
            fields: [
              {
                name: "message",
                value: "You have been ... !"
              }
            ]
          },
          {
            name: "action-select",
            value: "updateField",
            fields: [
              {
                name: "fieldId",
                value: "enemyField",
                fields: [
                  {
                    name: "newValue",
                    value: "enemy3"
                  }
               ]
             }
            ]
          }
        ]
      }; // end of actions config
-->
