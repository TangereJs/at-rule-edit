<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-rule-engine/at-rule-engine.html">
<link rel="import" href="../at-rule-conditions/at-rule-conditions.html">
<link rel="import" href="../at-rule-actions/at-rule-actions.html">

<dom-module id="at-rule-edit">
  <style>
    :host { 
      display: block;
      box-sizing: border-box;
    }
  </style>
  <template>
    <at-rule-conditions id="conditions" disabled="[[disabled]]"></at-rule-conditions>
    <at-rule-actions id="actions" disabled="[[disabled]]"></at-rule-actions>
  </template>
</dom-module>

<script>
  'use strict';
  Polymer({
    is: 'at-rule-edit',
    properties: {

      /**
       * When true disables the rule editing
       * 
       * @property disabled
       * @type Boolean
       * @default false
       */
      disabled: {
        type: Boolean,
        value: false
      },

      /**
       * Schema is an object of standard at-schema structure
       * 
       * @property schema
       * @type Object
       * @default {}
       */
      schema: {
        type: Object,
        value: function () {
          return {};
        }
      },

      /**
       * Rule config is an object with conditions array (with conditions definitions) and 
       * actions object (with actions definitions)
       *
       * @property ruleConfig
       * @type Object
       * @default { conditions: [], actions: {} }
       */
      ruleConfig: {
        type: Object,
        value: function() {
          return {
            conditions: [],
            actions: {}
          };
        }
      },

      /**
       * Value for conditions and actions
       * 
       * @property value
       * @type Object
       * @default { conditions: { kind: "all", conditions:[] }, actions: [] }
       */
      value: {
        type: Object,
        value: function() {
          return {
            conditions: {
              kind: "all",
              conditions: []
            },
            actions: []
          };
        },
        observer: '_valueChanged'
      }

    },

    observers: [ '_updateConfigOrSchema(ruleConfig, schema)'],

    ready: function() {
      var self = this;

      this.$.conditions.addEventListener('value-changed', function(event) {
        event.stopPropagation();
        self.value.conditions = self.$.conditions.value;
        self.fire('value-changed', { value: self.value }, { bubbles: false });  
      });

      this.$.actions.addEventListener('value-changed', function(event) {
        event.stopPropagation();
        self.value.actions = self.$.actions.value;
        self.fire('value-changed', { value: self.value }, { bubbles: false });
      });
    },

    _updateConfigOrSchema: function (ruleConfig, schema) {
      var ruleConfigEmpty = this._isConfigEmpty(ruleConfig);
      var schemaEmpty = this._isSchemaEmpty(schema);

      if (!ruleConfigEmpty && schemaEmpty) {
        this.$.conditions.config = ruleConfig.conditions;
        this.$.actions.config = ruleConfig.actions;
      } else {
        this.$.conditions.schema = schema;
        this.$.actions.schema = schema;
      }
    },

    _valueChanged: function(newValue, oldValue) {
      this.$.conditions.value = newValue.conditions;
      this.$.actions.value = newValue.actions;
    },

    _isSchemaEmpty: function(obj) {
      var result = obj && !obj.hasOwnProperty('properties');
      if (!result) {
        result = result || !Object.keys(obj.properties).length;
      }
      return result;
    },

    _isConfigEmpty: function(obj) {
      if (!obj || !obj.conditions || !obj.actions) {
        return true;
      }
      
      return !obj.conditions.length && !Object.keys(obj.actions).length;
    },

    // *ij* #638 upgrades
    // this function checks provided conditions and actions against a at-core-form
    checkAgainst: function(coreForm, customActionsAdapter) {

      var lConditions = this.value.conditions;
      var lActions = this.value.actions;
      var engine = new RuleEngine({
        conditions: lConditions,
        actions: lActions
      });

      var conditionsAdapter = coreForm.data;
      var actionsAdapter = {
        alert: function(data) {
          alert(data.message);
        },
        updateField: function(data) {
          var fieldId = data.fieldName;
          var val = data.updateTo;

          if (val === "true") {
            val = true;
          }
          if (val === "false") {
            val = false;
          }
          coreForm.updateFormElementData(fieldId, val);
        },
        setFieldState: function(data) {
          var fieldId = data.fieldName;
          var val = data.state;
          coreForm.setElementState(fieldId, val, val);
        },
        copyFieldValue: function(data) {
          var srcFieldId = data.fieldName;
          var destFieldId = data.copyTo;

          var srcValue = coreForm.data[srcFieldId];
          coreForm.updateFormElementData(destFieldId, srcValue);
        },
        setFieldError: function (data) {
          var fieldId = data.fieldName;
          var errorMessage = data.errorMessage;
          var field = coreForm.getElement(fieldId);
          if (field && field.errorMessage !== undefined) {
            field.errorMessage = errorMessage;
          }
        }
      };
      if (customActionsAdapter) {
        engine.run(conditionsAdapter, customActionsAdapter);
      } else {
        engine.run(conditionsAdapter, actionsAdapter);
      }
    }
  });
</script>
